<!DOCTYPE html>
<html lang="id" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cuaca Indonesia Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#0ea5e9',
              darkBg: '#0f172a',
              cardDark: '#1e293b',
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          },
        },
      };
    </script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: 'Inter', sans-serif;
        transition: background-color 0.3s, color 0.3s;
      }
      .glass {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .dark .glass {
        background: rgba(30, 41, 59, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0ea5e9;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }
    </style>
  </head>
  <body class="bg-slate-100 text-slate-800 dark:bg-darkBg dark:text-slate-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
      <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="flex items-center gap-2">
          <div class="bg-primary text-white p-2 rounded-lg">
            <i class="fa-solid fa-map-location-dot text-xl"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold tracking-tight">Cuaca Indonesia</h1>
            <p class="text-xs text-slate-500 dark:text-slate-400">Powered by Open-Meteo</p>
          </div>
        </div>

        <div
          class="flex items-center gap-3 bg-white dark:bg-cardDark p-1.5 rounded-full shadow-sm border border-slate-200 dark:border-slate-700"
        >
          <button
            id="unit-toggle"
            class="px-3 py-1 rounded-full text-xs font-bold bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 transition"
          >
            °C
          </button>
          <button
            id="theme-toggle"
            class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition text-yellow-500"
          >
            <i class="fa-solid fa-moon"></i>
          </button>
          <button
            id="refresh-btn"
            class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition text-green-500"
          >
            <i class="fa-solid fa-rotate-right"></i>
          </button>
        </div>
      </header>

      <div class="relative z-50 mb-8">
        <div class="relative shadow-lg rounded-xl">
          <input
            type="text"
            id="city-input"
            class="w-full p-4 pl-12 rounded-xl bg-white dark:bg-cardDark border-none outline-none ring-1 ring-slate-200 dark:ring-slate-700 focus:ring-2 focus:ring-primary transition"
            placeholder="Cari Kota / Kabupaten di Indonesia..."
            autocomplete="off"
          />
          <i
            class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"
          ></i>

          <div id="search-loader" class="absolute right-14 top-1/2 -translate-y-1/2 hidden">
            <div class="loader w-5 h-5 border-2"></div>
          </div>

          <button
            id="save-fav-btn"
            class="absolute right-3 top-1/2 -translate-y-1/2 p-2 text-slate-400 hover:text-yellow-400 transition"
            title="Simpan Lokasi"
          >
            <i class="fa-regular fa-star"></i>
          </button>
        </div>

        <ul
          id="suggestions-list"
          class="hidden absolute w-full bg-white dark:bg-cardDark mt-2 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 max-h-60 overflow-y-auto overflow-x-hidden"
        ></ul>

        <div id="favorites-container" class="mt-3 flex flex-wrap gap-2 min-h-[30px]"></div>
      </div>

      <main id="dashboard" class="hidden animate-fade-in">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div
            class="glass p-6 rounded-3xl relative overflow-hidden bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-xl"
          >
            <div class="relative z-10">
              <div class="flex justify-between items-start">
                <div>
                  <h2 id="display-city" class="text-3xl font-bold">Jakarta</h2>
                  <p id="display-region" class="text-sm text-blue-100 mb-4 opacity-90">
                    DKI Jakarta
                  </p>
                  <p
                    id="timestamp"
                    class="text-xs bg-white/20 inline-block px-2 py-1 rounded backdrop-blur-sm"
                  >
                    Updated Just Now
                  </p>
                </div>
                <div class="text-right">
                  <i id="weather-icon-main" class="fa-solid fa-cloud text-5xl opacity-90"></i>
                </div>
              </div>

              <div class="mt-8 flex items-end gap-2">
                <span id="current-temp" class="text-6xl font-bold tracking-tighter">29</span>
                <span class="text-2xl font-medium mb-2 relative -top-1 unit-display">°C</span>
              </div>
              <p id="weather-desc" class="text-lg font-medium mt-1">Cerah Berawan</p>
            </div>

            <div
              class="absolute -bottom-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl"
            ></div>
            <div
              class="absolute top-10 -left-10 w-20 h-20 bg-yellow-300 opacity-20 rounded-full blur-xl"
            ></div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div
              class="glass dark:bg-cardDark p-4 rounded-2xl flex flex-col justify-center items-center text-center shadow-sm"
            >
              <i class="fa-solid fa-droplet text-blue-400 text-xl mb-2"></i>
              <span class="text-xs text-slate-500 dark:text-slate-400">Kelembapan</span>
              <span id="humidity" class="text-xl font-bold">--%</span>
            </div>
            <div
              class="glass dark:bg-cardDark p-4 rounded-2xl flex flex-col justify-center items-center text-center shadow-sm"
            >
              <i class="fa-solid fa-wind text-teal-400 text-xl mb-2"></i>
              <span class="text-xs text-slate-500 dark:text-slate-400">Angin</span>
              <span id="wind-speed" class="text-xl font-bold">-- km/h</span>
            </div>
            <div
              class="glass dark:bg-cardDark p-4 rounded-2xl flex flex-col justify-center items-center text-center shadow-sm"
            >
              <i class="fa-solid fa-temperature-arrow-up text-red-400 text-xl mb-2"></i>
              <span class="text-xs text-slate-500 dark:text-slate-400">Max Harian</span>
              <span id="temp-max-today" class="text-xl font-bold">--°</span>
            </div>
            <div
              class="glass dark:bg-cardDark p-4 rounded-2xl flex flex-col justify-center items-center text-center shadow-sm"
            >
              <i class="fa-solid fa-temperature-arrow-down text-indigo-400 text-xl mb-2"></i>
              <span class="text-xs text-slate-500 dark:text-slate-400">Min Harian</span>
              <span id="temp-min-today" class="text-xl font-bold">--°</span>
            </div>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i class="fa-regular fa-calendar-alt text-primary"></i> Prakiraan 5 Hari
          </h3>
          <div id="forecast-container" class="space-y-3"></div>
        </div>
      </main>

      <div
        id="loading-overlay"
        class="hidden fixed inset-0 bg-white/50 dark:bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center"
      >
        <div class="loader"></div>
      </div>

      <div
        id="error-msg"
        class="hidden mt-10 text-center p-8 bg-red-50 dark:bg-red-900/20 rounded-2xl text-red-600 dark:text-red-400"
      >
        <i class="fa-solid fa-triangle-exclamation text-3xl mb-2"></i>
        <p id="error-text">Terjadi kesalahan.</p>
      </div>
    </div>

    <script>
      const CONFIG = {
        geoApi: 'https://geocoding-api.open-meteo.com/v1/search',
        weatherApi: 'https://api.open-meteo.com/v1/forecast',
        refreshInterval: 300000,
      };

      let state = {
        lat: -6.1751,
        lon: 106.865,
        city: 'Jakarta',
        region: 'DKI Jakarta',
        unit: 'celsius',
        theme: 'light',
        favorites: JSON.parse(sessionStorage.getItem('indoWeatherFavs')) || [],
        timer: null,
      };

      const els = {
        input: document.getElementById('city-input'),
        suggestions: document.getElementById('suggestions-list'),
        searchLoader: document.getElementById('search-loader'),
        favContainer: document.getElementById('favorites-container'),
        dashboard: document.getElementById('dashboard'),
        loadingOverlay: document.getElementById('loading-overlay'),
        errorMsg: document.getElementById('error-msg'),
        saveBtn: document.getElementById('save-fav-btn'),
        displayCity: document.getElementById('display-city'),
        displayRegion: document.getElementById('display-region'),
        timestamp: document.getElementById('timestamp'),
        currentTemp: document.getElementById('current-temp'),
        weatherDesc: document.getElementById('weather-desc'),
        mainIcon: document.getElementById('weather-icon-main'),
        humidity: document.getElementById('humidity'),
        wind: document.getElementById('wind-speed'),
        maxToday: document.getElementById('temp-max-today'),
        minToday: document.getElementById('temp-min-today'),
        forecastList: document.getElementById('forecast-container'),
        unitToggle: document.getElementById('unit-toggle'),
        themeToggle: document.getElementById('theme-toggle'),
        refreshBtn: document.getElementById('refresh-btn'),
      };

      function getWeatherDesc(code) {
        const map = {
          0: { label: 'Cerah', icon: 'fa-sun', color: 'text-yellow-500' },
          1: { label: 'Cerah Berawan', icon: 'fa-cloud-sun', color: 'text-yellow-400' },
          2: { label: 'Berawan', icon: 'fa-cloud', color: 'text-gray-400' },
          3: { label: 'Mendung', icon: 'fa-cloud', color: 'text-gray-500' },
          45: { label: 'Berkabut', icon: 'fa-smog', color: 'text-gray-400' },
          48: { label: 'Kabut Tebal', icon: 'fa-smog', color: 'text-gray-500' },
          51: { label: 'Gerimis Ringan', icon: 'fa-cloud-rain', color: 'text-blue-300' },
          53: { label: 'Gerimis', icon: 'fa-cloud-rain', color: 'text-blue-400' },
          55: { label: 'Gerimis Lebat', icon: 'fa-cloud-showers-heavy', color: 'text-blue-500' },
          61: { label: 'Hujan Ringan', icon: 'fa-cloud-rain', color: 'text-blue-400' },
          63: { label: 'Hujan Sedang', icon: 'fa-cloud-showers-heavy', color: 'text-blue-500' },
          65: { label: 'Hujan Lebat', icon: 'fa-cloud-showers-water', color: 'text-blue-600' },
          80: { label: 'Hujan Lokal', icon: 'fa-cloud-sun-rain', color: 'text-blue-400' },
          81: {
            label: 'Hujan Lokal Deras',
            icon: 'fa-cloud-showers-heavy',
            color: 'text-blue-600',
          },
          82: { label: 'Hujan Badai', icon: 'fa-poo-storm', color: 'text-purple-500' },
          95: { label: 'Badai Petir', icon: 'fa-bolt', color: 'text-yellow-500' },
          96: { label: 'Badai Petir Ringan', icon: 'fa-bolt-lightning', color: 'text-yellow-600' },
          99: { label: 'Badai Petir Dahsyat', icon: 'fa-bolt', color: 'text-red-500' },
        };
        return (
          map[code] || { label: 'Tidak Diketahui', icon: 'fa-question', color: 'text-gray-400' }
        );
      }

      function init() {
        if (sessionStorage.getItem('theme') === 'dark') {
          document.documentElement.classList.add('dark');
          els.themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
          state.theme = 'dark';
        }
        const lastSession = JSON.parse(sessionStorage.getItem('lastLoc'));
        if (lastSession) {
          state.lat = lastSession.lat;
          state.lon = lastSession.lon;
          state.city = lastSession.city;
          state.region = lastSession.region || '';
        }
        renderFavorites();
        fetchWeatherData();
        startAutoRefresh();
      }

      let searchTimeout;
      els.input.addEventListener('input', (e) => {
        const query = e.target.value;
        clearTimeout(searchTimeout);
        if (query.length < 3) {
          els.suggestions.classList.add('hidden');
          return;
        }
        els.searchLoader.classList.remove('hidden');
        searchTimeout = setTimeout(async () => {
          try {
            const res = await fetch(
              `${CONFIG.geoApi}?name=${query}&count=10&language=id&format=json`
            );
            const data = await res.json();
            els.suggestions.innerHTML = '';
            if (!data.results) {
              els.suggestions.classList.add('hidden');
              return;
            }
            const indoCities = data.results.filter((item) => item.country_code === 'ID');
            if (indoCities.length === 0) {
              const li = document.createElement('li');
              li.className = 'px-4 py-3 text-sm text-gray-500 text-center';
              li.textContent = 'Lokasi tidak ditemukan di Indonesia';
              els.suggestions.appendChild(li);
            } else {
              indoCities.forEach((place) => {
                const li = document.createElement('li');
                li.className =
                  'px-4 py-3 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-50 dark:border-slate-800 last:border-0 flex justify-between items-center';
                const adminArea = place.admin1 || place.admin2 || 'Indonesia';
                li.innerHTML = `
                                <div>
                                    <span class="font-semibold block text-slate-700 dark:text-slate-200">${place.name}</span>
                                    <span class="text-xs text-slate-500">${adminArea}</span>
                                </div>
                                <i class="fa-solid fa-chevron-right text-xs text-slate-300"></i>
                            `;
                li.onclick = () => {
                  selectLocation(place);
                };
                els.suggestions.appendChild(li);
              });
            }
            els.suggestions.classList.remove('hidden');
          } catch (err) {
            console.error(err);
          } finally {
            els.searchLoader.classList.add('hidden');
          }
        }, 500);
      });

      function selectLocation(place) {
        state.lat = place.latitude;
        state.lon = place.longitude;
        state.city = place.name;
        state.region = place.admin1 || '';
        els.input.value = place.name;
        els.suggestions.classList.add('hidden');
        sessionStorage.setItem(
          'lastLoc',
          JSON.stringify({
            lat: state.lat,
            lon: state.lon,
            city: state.city,
            region: state.region,
          })
        );
        fetchWeatherData();
        checkFavoriteStatus();
      }

      async function fetchWeatherData() {
        showLoading(true);
        els.errorMsg.classList.add('hidden');
        try {
          const unitParam =
            state.unit === 'fahrenheit' ? '&temperature_unit=fahrenheit&wind_speed_unit=mph' : '';
          const url = `${CONFIG.weatherApi}?latitude=${state.lat}&longitude=${state.lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto${unitParam}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('Gagal mengambil data cuaca');
          const data = await res.json();
          updateUI(data);
          showLoading(false);
          els.dashboard.classList.remove('hidden');
        } catch (err) {
          showLoading(false);
          els.dashboard.classList.add('hidden');
          els.errorMsg.classList.remove('hidden');
          document.getElementById('error-text').textContent = err.message;
        }
      }

      function updateUI(data) {
        const current = data.current;
        const daily = data.daily;
        const weatherInfo = getWeatherDesc(current.weather_code);
        const unitSymbol = state.unit === 'celsius' ? '°C' : '°F';
        const speedUnit = state.unit === 'celsius' ? 'km/h' : 'mph';
        els.displayCity.textContent = state.city;
        els.displayRegion.textContent = state.region;
        const now = new Date();
        els.timestamp.textContent = `Update: ${now.toLocaleTimeString('id-ID', {
          hour: '2-digit',
          minute: '2-digit',
        })}`;
        els.currentTemp.textContent = Math.round(current.temperature_2m);
        document.querySelectorAll('.unit-display').forEach((el) => (el.textContent = unitSymbol));
        els.weatherDesc.textContent = weatherInfo.label;
        els.mainIcon.className = `fa-solid ${weatherInfo.icon} text-5xl md:text-7xl ${weatherInfo.color}`;
        els.humidity.textContent = `${current.relative_humidity_2m}%`;
        els.wind.textContent = `${current.wind_speed_10m} ${speedUnit}`;
        els.maxToday.textContent = `${Math.round(daily.temperature_2m_max[0])}°`;
        els.minToday.textContent = `${Math.round(daily.temperature_2m_min[0])}°`;
        els.forecastList.innerHTML = '';
        for (let i = 0; i < 5; i++) {
          const date = new Date(daily.time[i]);
          const dayName =
            i === 0 ? 'Hari Ini' : date.toLocaleDateString('id-ID', { weekday: 'long' });
          const dateStr = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
          const code = daily.weather_code[i];
          const info = getWeatherDesc(code);
          const min = Math.round(daily.temperature_2m_min[i]);
          const max = Math.round(daily.temperature_2m_max[i]);
          const row = `
                    <div class="glass dark:bg-cardDark p-3 rounded-xl flex items-center justify-between shadow-sm hover:scale-[1.01] transition duration-200">
                        <div class="w-1/3">
                            <p class="font-semibold text-sm">${dayName}</p>
                            <p class="text-xs text-slate-500">${dateStr}</p>
                        </div>
                        <div class="flex flex-col items-center w-1/3">
                            <i class="fa-solid ${info.icon} ${info.color} text-xl mb-1"></i>
                            <span class="text-xs text-slate-500 truncate max-w-full">${info.label}</span>
                        </div>
                        <div class="w-1/3 text-right font-mono font-medium text-sm">
                            <span class="text-slate-400">${min}°</span> / <span class="text-slate-800 dark:text-white">${max}°</span>
                        </div>
                    </div>
                `;
          els.forecastList.insertAdjacentHTML('beforeend', row);
        }
        checkFavoriteStatus();
      }

      function showLoading(active) {
        if (active) els.loadingOverlay.classList.remove('hidden');
        else els.loadingOverlay.classList.add('hidden');
      }

      function startAutoRefresh() {
        if (state.timer) clearInterval(state.timer);
        state.timer = setInterval(() => {
          fetchWeatherData();
        }, CONFIG.refreshInterval);
      }

      function checkFavoriteStatus() {
        const isFav = state.favorites.some((f) => f.city === state.city);
        const icon = els.saveBtn.querySelector('i');
        if (isFav) {
          icon.className = 'fa-solid fa-star text-yellow-400';
        } else {
          icon.className = 'fa-regular fa-star text-slate-400';
        }
      }

      function renderFavorites() {
        els.favContainer.innerHTML = '';
        state.favorites.forEach((fav) => {
          const chip = document.createElement('div');
          chip.className =
            'bg-white dark:bg-cardDark px-3 py-1 rounded-full text-xs border border-slate-200 dark:border-slate-600 flex items-center gap-2 shadow-sm cursor-pointer hover:bg-slate-50 transition';
          chip.innerHTML = `
                    <span>${fav.city}</span>
                    <span class="text-red-400 hover:text-red-600 rounded-full w-4 h-4 flex items-center justify-center font-bold" onclick="removeFavorite(event, '${fav.city}')">&times;</span>
                `;
          chip.onclick = (e) => {
            if (e.target.tagName !== 'SPAN' || e.target.textContent !== '×') {
              state.lat = fav.lat;
              state.lon = fav.lon;
              state.city = fav.city;
              state.region = fav.region;
              els.input.value = fav.city;
              fetchWeatherData();
            }
          };
          els.favContainer.appendChild(chip);
        });
      }

      els.saveBtn.addEventListener('click', () => {
        const exists = state.favorites.some((f) => f.city === state.city);
        if (!exists) {
          state.favorites.push({
            city: state.city,
            region: state.region,
            lat: state.lat,
            lon: state.lon,
          });
          sessionStorage.setItem('indoWeatherFavs', JSON.stringify(state.favorites));
          renderFavorites();
          checkFavoriteStatus();
        }
      });

      window.removeFavorite = (e, cityName) => {
        e.stopPropagation();
        state.favorites = state.favorites.filter((f) => f.city !== cityName);
        sessionStorage.setItem('indoWeatherFavs', JSON.stringify(state.favorites));
        renderFavorites();
        checkFavoriteStatus();
      };

      els.unitToggle.addEventListener('click', () => {
        state.unit = state.unit === 'celsius' ? 'fahrenheit' : 'celsius';
        els.unitToggle.textContent = state.unit === 'celsius' ? '°C' : '°F';
        fetchWeatherData();
      });

      els.themeToggle.addEventListener('click', () => {
        const html = document.documentElement;
        if (html.classList.contains('dark')) {
          html.classList.remove('dark');
          els.themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
          state.theme = 'light';
        } else {
          html.classList.add('dark');
          els.themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
          state.theme = 'dark';
        }
        sessionStorage.setItem('theme', state.theme);
      });

      els.refreshBtn.addEventListener('click', () => {
        const icon = els.refreshBtn.querySelector('i');
        icon.classList.add('fa-spin');
        fetchWeatherData().then(() => {
          setTimeout(() => icon.classList.remove('fa-spin'), 600);
        });
      });

      document.addEventListener('click', (e) => {
        if (!els.input.contains(e.target) && !els.suggestions.contains(e.target)) {
          els.suggestions.classList.add('hidden');
        }
      });

      init();
    </script>
  </body>
</html>
